<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>낮은 땅으로부터의 회신</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="./assets/style.css">
  <!-- Styles moved to assets/style.css -->
</head>
<script>
  (function (d) {
    var config = {
        kitId: 'cgc8yqp',
        scriptTimeout: 3000,
        async: true
      },
      h = d.documentElement,
      t = setTimeout(function () {
        h.className = h.className.replace(/\bwf-loading\b/g, "") + " wf-inactive";
      }, config.scriptTimeout),
      tk = d.createElement("script"),
      f = false,
      s = d.getElementsByTagName("script")[0],
      a;
    h.className += " wf-loading";
    tk.src = 'https://use.typekit.net/' + config.kitId + '.js';
    tk.async = true;
    tk.onload = tk.onreadystatechange = function () {
      a = this.readyState;
      if (f || a && a != "complete" && a != "loaded") return;
      f = true;
      clearTimeout(t);
      try {
        Typekit.load(config)
      } catch (e) {}
    };
    s.parentNode.insertBefore(tk, s)
  })(document);
</script>

<body>
  <div id="menu-bar"></div>
  <div id="restart-overlay">Restart</div>
  <div id="press-overlay" style="display:none;">길게 누르기<br>Press</div>
  <div id="keep-press-overlay" style="display:none;">게속 누르기<br>Keep Press</div>
  <div id="center-text">2024-12-03,22:27</div>
  <div class="clip-bg" id="clip-bg">
    <div class="clip-text" id="clip-text">
    </div>
  </div>
  <div id="article-list" class="article-list"></div>
  <!-- Matter.js 라이브러리 로드 -->
  <script src="../build/matter.js"></script>
  <script src="./assets/canvas.js"></script>
  <script src="./assets/clipmask.js"></script>
  <script src="./assets/datePhysics.js"></script>
  <script src="./assets/articleLoader.js"></script>
  <script>
    // Press overlay shows on every click
    var pressOverlay = document.getElementById('press-overlay');
    var keepPressOverlay = document.getElementById('keep-press-overlay');
    var keepPressTimeout = null;
    
    // Speed control system
    var speedMultiplier = 1.0; // Normal speed
    var isPressed = false;
    var lastInteractionTime = Date.now();
    var speedUpdateInterval = null;
    
    // Speed levels
    var SPEED_LEVELS = {
      IDLE: 0.1,      // Very slow when no interaction
      PRESSED: 1.0,   // Normal speed when pressed
      NORMAL: 0.5     // 1/2 speed normally
    };
    
    function updateSpeed() {
      var now = Date.now();
      var timeSinceInteraction = now - lastInteractionTime;
      
      if (isPressed) {
        speedMultiplier = SPEED_LEVELS.PRESSED; // Normal speed when pressed
      } else if (timeSinceInteraction > 5000) { // 5 seconds of no interaction
        speedMultiplier = SPEED_LEVELS.IDLE;    // Very slow when idle
      } else {
        speedMultiplier = SPEED_LEVELS.NORMAL;  // 1/2 speed normally
      }
      
      // Expose speedMultiplier and isPressed globally for other scripts
      window.speedMultiplier = speedMultiplier;
      window.isPressed = isPressed;
      
      // Update Matter.js engine speed
      if (window.engine && window.engine.timing) {
        window.engine.timing.timeScale = speedMultiplier;
      }
      
      // Update interval speeds
      if (pressIntervalId) {
        clearInterval(pressIntervalId);
        pressIntervalId = setInterval(function () {
          if (window.addOneDay) window.addOneDay();
          if (window.nextArticle) window.nextArticle();
        }, 1000 / speedMultiplier);
      }
      
      // Update spawn interval if it exists
      if (window.updateSpawnInterval) {
        window.updateSpawnInterval();
      }
      
      // Create article item when pressed
      if (window.createArticleItem && isPressed) {
        window.createArticleItem();
      }
    }
    
    function resetInteractionTimer() {
      lastInteractionTime = Date.now();
      updateSpeed();
    }

    function showPressOverlay() {
      // Don't show overlays during automatic playback
      return;
    }

    function hidePressOverlay() {
      if (pressOverlay) {
        pressOverlay.classList.add('fade-out');
        setTimeout(function () {
          pressOverlay.style.display = 'none';
        }, 200);
      }
    }

    function scheduleKeepPress() {
      // Don't show keep press overlay during automatic playback
      return;
    }

    function hideKeepPress() {
      if (!keepPressOverlay) return;
      clearTimeout(keepPressTimeout);
      keepPressOverlay.style.display = 'none';
    }
    // 날짜와 클리핑 마스크 인터랙션 + 기사 변경
    var pressIntervalId = null;
    document.body.addEventListener('mousedown', function (e) {
      if (e.target.closest('#article-list')) return; // ignore clicks in sidebar
      
      // Set pressed state and update speed
      isPressed = true;
      resetInteractionTimer();
      
      if (window.startClipShake) window.startClipShake();
      if (window.addOneDay) window.addOneDay();
      if (window.nextArticle) window.nextArticle();
      if (pressIntervalId) return;
      pressIntervalId = setInterval(function () {
        if (window.addOneDay) window.addOneDay();
        if (window.nextArticle) window.nextArticle();
      }, 1000 / speedMultiplier);
    });
    document.body.addEventListener('mouseup', function (e) {
      if (e.target.closest('#article-list')) return;
      if (window.stopClipShake) window.stopClipShake();
      clearInterval(pressIntervalId);
      pressIntervalId = null;

      // Reset pressed state and update speed
      isPressed = false;
      resetInteractionTimer();
    });
    document.body.addEventListener('mouseleave', function (e) {
      if (e.target.closest('#article-list')) return;
      if (window.stopClipShake) window.stopClipShake();
      clearInterval(pressIntervalId);
      pressIntervalId = null;

      // Reset pressed state and update speed
      isPressed = false;
      resetInteractionTimer();
    });

    // ------------------ Auto Refresh on Inactivity ------------------
    (function () {
      function resetTimer() {
        clearTimeout(window.__idleTimer);
        window.__idleTimer = setTimeout(function() {
          location.reload();
        }, 2 * 60 * 1000); // 2 minutes
      }
      ['mousemove', 'mousedown', 'keydown', 'touchstart'].forEach(function (ev) {
        document.addEventListener(ev, resetTimer, {
          passive: true
        });
        document.addEventListener(ev, resetInteractionTimer, {
          passive: true
        });
      });
      resetTimer();
    })();

    // ------------------ Continuous Speed Update ------------------
    (function () {
      // Update speed every 100ms
      speedUpdateInterval = setInterval(function() {
        updateSpeed();
      }, 100);
      
      // Initial speed update
      updateSpeed();
    })();

    // ------------------ Auto Start Playback ------------------
    (function () {
      // Wait for all scripts to load, then start automatic playback
      setTimeout(function() {
        // Start automatic date and article progression
        if (window.addOneDay) window.addOneDay();
        if (window.nextArticle) window.nextArticle();
        
        // Start automatic interval for continuous progression (slower by default)
        setInterval(function () {
          if (window.addOneDay) window.addOneDay();
          if (window.nextArticle) window.nextArticle();
        }, 4000); // Every 4 seconds (slower than original 2 seconds)
        
        // Start canvas interactions if available
        if (window.startSpawningRects) window.startSpawningRects();
        // Force initial spawn to ensure blocks start appearing
        if (window.spawnNextWordBlock) window.spawnNextWordBlock();
        
        // Start clip mask shake to reveal the clipping mask
        if (window.startClipShake) window.startClipShake();
        
        // Show date and link elements
        if (window.fadeInDate) window.fadeInDate();
        if (window.fadeInLink) window.fadeInLink();
        
        // Trigger initial interactions
        resetInteractionTimer();
      }, 1000); // Wait 1 second for everything to load
    })();


  </script>
</body>

</html>