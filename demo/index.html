<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Matter.js Ball Pool Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    canvas {
      display: block;
    }

    #center-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      font-weight: bold;
      color: #222;
      pointer-events: auto;
      z-index: 10;
      user-select: none;
    }

    #eye-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="center-text">2024-12-03,22:27</div>
  <div id="eye-container">
    <svg id="eye-svg" width="80" height="80" viewBox="0 0 80 80">
      <ellipse cx="40" cy="40" rx="35" ry="30" fill="#fff" stroke="#222" stroke-width="3" />
      <circle id="pupil" cx="40" cy="40" r="10" fill="#222" />
    </svg>
  </div>
  <!-- Matter.js 라이브러리 로드 -->
  <script src="../build/matter.js"></script>
  <!-- Ball Pool 예제 코드 직접 삽입 -->
  <script>
    // Matter.js 네임스페이스 가져오기
    var Engine = Matter.Engine,
      Render = Matter.Render,
      Runner = Matter.Runner,
      Composites = Matter.Composites,
      Common = Matter.Common,
      MouseConstraint = Matter.MouseConstraint,
      Mouse = Matter.Mouse,
      World = Matter.World,
      Bodies = Matter.Bodies;

    // 엔진 생성
    var engine = Engine.create(),
      world = engine.world;

    // 렌더러 생성
    var render = Render.create({
      element: document.body,
      engine: engine,
      options: {
        width: window.innerWidth,
        height: window.innerHeight,
        wireframes: false,
        background: '#fff'
      }
    });

    Render.run(render);

    // 러너 생성
    var runner = Runner.create();
    Runner.run(runner, engine);

    // 벽 생성 함수 (상단 벽 없음, 나머지는 화면에 붙게)
    function createWalls() {
      return [
        Bodies.rectangle(window.innerWidth / 2, window.innerHeight, window.innerWidth, 50, {
          isStatic: true
        }), // 하단
        Bodies.rectangle(window.innerWidth, window.innerHeight / 2, 50, window.innerHeight, {
          isStatic: true
        }), // 우측
        Bodies.rectangle(0, window.innerHeight / 2, 50, window.innerHeight, {
          isStatic: true
        }) // 좌측
      ];
    }

    // 랜덤 위치에 사각형 생성 함수 (항상 화면 바깥 상단에서 생성)
    function createRandomRect() {
      var size = 40;
      var x = Common.random(size + 10, window.innerWidth - size - 10);
      var y = -size; // 화면 바깥 상단
      var isBlack = Common.random() > 0.5;
      return Bodies.rectangle(x, y, size, size, {
        restitution: 0.9,
        friction: 0.005,
        density: 0.001,
        render: {
          fillStyle: isBlack ? '#000' : '#fff',
          strokeStyle: '#222',
          lineWidth: 1
        }
      });
    }

    // 초기 사각형 여러 개 생성
    function createInitialRects(count) {
      var rects = [];
      for (var i = 0; i < count; i++) {
        rects.push(createRandomRect());
      }
      return rects;
    }

    var walls = createWalls();
    var rects = createInitialRects(20);

    World.add(world, walls);
    World.add(world, rects);

    // 마우스 컨트롤 추가
    var mouse = Mouse.create(render.canvas),
      mouseConstraint = MouseConstraint.create(engine, {
        mouse: mouse,
        constraint: {
          stiffness: 0.2,
          render: {
            visible: false
          }
        }
      });

    World.add(world, mouseConstraint);
    render.mouse = mouse;

    // 반응형 리사이즈
    window.addEventListener('resize', function () {
      render.options.width = window.innerWidth;
      render.options.height = window.innerHeight;
      render.canvas.width = window.innerWidth;
      render.canvas.height = window.innerHeight;

      // 월드에서 기존 벽, 사각형, 마우스 컨스트레인트 제거
      World.clear(world, false);

      // 새 벽, 기존 사각형, 마우스 컨스트레인트 추가
      walls = createWalls();
      World.add(world, walls);
      World.add(world, rects);
      World.add(world, mouseConstraint);
    });

    // 마우스 프레스 시 사각형 생성 → 마우스 누르고 있는 동안 계속 생성
    var spawnIntervalId = null;

    function startSpawningRects() {
      if (spawnIntervalId) return; // 이미 실행 중이면 중복 실행 방지
      spawnIntervalId = setInterval(function () {
        var rect = createRandomRect();
        rects.push(rect);
        World.add(world, rect);
      }, 100); // 100ms마다 생성 (원하는 속도로 조절)
    }

    function stopSpawningRects() {
      clearInterval(spawnIntervalId);
      spawnIntervalId = null;
    }

    render.canvas.addEventListener('mousedown', function (event) {
      startSpawningRects();
    });

    render.canvas.addEventListener('mouseup', function (event) {
      stopSpawningRects();
    });

    render.canvas.addEventListener('mouseleave', function (event) {
      stopSpawningRects();
    });

    function createTextBodies(text, fontSize, fontFamily) {
      // 1. 임시 캔버스에 글자 그림
      var tempCanvas = document.createElement('canvas');
      tempCanvas.width = 400;
      tempCanvas.height = 100;
      var ctx = tempCanvas.getContext('2d');
      ctx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
      ctx.font = fontSize + 'px ' + fontFamily;
      ctx.textBaseline = 'middle';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#000';
      ctx.fillText(text, tempCanvas.width / 2, tempCanvas.height / 2);

      // 2. 픽셀 데이터 읽기
      var imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      var bodies = [];
      var step = 8; // 점 간격(조밀할수록 더 글자 모양에 가까움, 성능과 트레이드오프)
      for (var y = 0; y < tempCanvas.height; y += step) {
        for (var x = 0; x < tempCanvas.width; x += step) {
          var idx = (y * tempCanvas.width + x) * 4;
          if (imageData.data[idx + 3] > 128) { // 알파값이 충분히 크면
            // 월드 중앙 기준으로 위치 조정
            var worldX = window.innerWidth / 2 - tempCanvas.width / 2 + x;
            var worldY = window.innerHeight / 2 - tempCanvas.height / 2 + y;
            bodies.push(Bodies.circle(worldX, worldY, step / 2, {
              isStatic: true,
              render: {
                fillStyle: 'rgba(0,0,0,0)'
              }
            }));
          }
        }
      }
      return bodies;
    }

    // 날짜 상태 및 포맷 함수
    var currentDate = new Date(2024, 11, 3, 22, 27); // 11=12월 (JS는 0부터 시작)
    function formatDate(date) {
      var y = date.getFullYear();
      var m = (date.getMonth() + 1).toString().padStart(2, '0');
      var d = date.getDate().toString().padStart(2, '0');
      var h = date.getHours().toString().padStart(2, '0');
      var min = date.getMinutes().toString().padStart(2, '0');
      return `${y}-${m}-${d},${h}:${min}`;
    }

    // 텍스트와 물리 바디 갱신 함수
    function updateDateTextAndBodies() {
      document.getElementById('center-text').textContent = formatDate(currentDate);
      if (window.textBodies) World.remove(world, window.textBodies);
      window.textBodies = createTextBodies(formatDate(currentDate), 48, 'Arial');
      World.add(world, window.textBodies);
    }

    // 초기화
    updateDateTextAndBodies();

    // 클릭/프레스 이벤트 처리
    var pressIntervalId = null;

    function addOneDay() {
      currentDate.setDate(currentDate.getDate() + 1);
      updateDateTextAndBodies();
    }
    var centerTextDiv = document.getElementById('center-text');
    // 눈 흔들림 인터랙션
    var pupil = document.getElementById('pupil');
    var eyeShakeInterval = null;
    var pupilOrigin = {
      x: 40,
      y: 40
    };

    function startEyeShake() {
      if (eyeShakeInterval) return;
      eyeShakeInterval = setInterval(function () {
        var dx = (Math.random() - 0.5) * 10;
        var dy = (Math.random() - 0.5) * 10;
        pupil.setAttribute('cx', pupilOrigin.x + dx);
        pupil.setAttribute('cy', pupilOrigin.y + dy);
      }, 40);
    }

    function stopEyeShake() {
      clearInterval(eyeShakeInterval);
      eyeShakeInterval = null;
      pupil.setAttribute('cx', pupilOrigin.x);
      pupil.setAttribute('cy', pupilOrigin.y);
    }
    // 기존 centerTextDiv 이벤트 리스너 제거
    // centerTextDiv.addEventListener('mousedown', ...);
    // centerTextDiv.addEventListener('mouseup', ...);
    // centerTextDiv.addEventListener('mouseleave', ...);

    // 화면 전체에서 인터렉션 동작
    document.body.addEventListener('mousedown', function (e) {
      startEyeShake();
      addOneDay();
      if (pressIntervalId) return;
      pressIntervalId = setInterval(addOneDay, 120);
    });
    document.body.addEventListener('mouseup', function (e) {
      stopEyeShake();
      clearInterval(pressIntervalId);
      pressIntervalId = null;
    });
    document.body.addEventListener('mouseleave', function (e) {
      stopEyeShake();
      clearInterval(pressIntervalId);
      pressIntervalId = null;
    });
  </script>
</body>

</html>